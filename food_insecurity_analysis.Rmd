---
title: "food_insecurity_analysis"
output: html_document
---
### Load in data

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)
#install.packages("ggmap", type = "source")
library(ggmap)
library(choroplethr)
library(choroplethrMaps)
```

### Note: I'm removing PR from the start
```{r}
# Read in data
fea <- read_csv('fea_04062017.csv')
fea <- filter(fea, State != "PR")
# For county plotting purposes
fea$region <- as.numeric(fea$FIPS)
#colnames(fea)
```

As our project focuses on Food Insecurity in the US, the first variable(s) we will begin to analyze are those related to food insecurity. The documentation defines household food insecurity as those households which “were unable, at times during the year, to provide adequate food for one or more household members because the household lacked money and other resources for food.” The documentation adds that this inadequacy was in both “quality and variety of foods”. Households with very low food insecurity are categorized as households where “food intake of one or more members was reduced and eating patterns were disrupted at times during the year because of insufficient money and other resources for food.”

Note: Food insecurity data is at the state level

#### Do we want to talk about "very low food insecurity"?

```{r}
fea %>% 
  group_by(State) %>% 
  summarise_all(mean) -> 
  state_data

# Bring in state abbreviation to name mapping
data(state)
state_abbrevs <- tibble(abb = state.abb, region = tolower(state.name))
state_abbrevs <- add_row(state_abbrevs, abb = 'DC', region = 'district of columbia')

state_data <- left_join(state_data, state_abbrevs, by = c('State' = 'abb'))

##### How to plot panel of FOODINSEC_07_09 and FOODINSEC_10_12?
##### Set a manual scale

par(mfrow = c(1, 2))
state_choropleth(mutate(state_data, value = FOODINSEC_07_09), title = "Household Food Insecurity (%), 2007-2009")
state_choropleth(mutate(state_data, value = FOODINSEC_10_12), title = "Household Food Insecurity (%), 2010-2012")
```

The below charts explore average food insecurity for 2007-2009 and 2010-2012 by state. Here we see the range of percent of households experiencing food insecurity is increasing: from 07-09 the range was 6.7-17.7%, whereas from 10-12 the range was 8.7-20.9%.

```{r}
# Cleveland dot plot theme
theme_dotplot1 <- theme_bw(10) +
    theme(axis.text.y = element_text(size = rel(.8)),
          axis.ticks.y = element_blank(),
          axis.title.x = element_text(),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(size = 0.5),
          panel.grid.minor.x = element_blank())
```


```{r}
insec_bar <- state_data %>% select(State, FOODINSEC_07_09, FOODINSEC_10_12)

ggplot(insec_bar, aes(x = reorder(State, FOODINSEC_07_09), y = FOODINSEC_07_09)) +
    geom_point() + 
    theme_dotplot1 + 
    coord_flip() +
    ggtitle("Household food insecurity by state (%, 3-year avg) - 2007-2009") +
    ylab("Household food insecurity (%, 3-year avg)") + xlab("")
```

```{r}
ggplot(insec_bar, aes(x = reorder(State, FOODINSEC_10_12), y = FOODINSEC_10_12)) +
    geom_point() + 
    theme_dotplot1 + 
    coord_flip() +
    ggtitle("Household food insecurity by state (%, 3-year avg) - 2010-2012") +
    ylab("Household food insecurity (%, 3-year avg)") + xlab("")
```

```{r}
insec_bar_tidy <- insec_bar %>% gather("Year", "Value", -State)

ggplot(insec_bar_tidy, aes(x = reorder(State, Value), y = Value, color = Year)) +
    geom_point() + 
    theme_dotplot1 + 
    coord_flip() +
    ggtitle("Household food insecurity by state (%, 3-year avg) - 2007-09 vs. 2010-12") +
    ylab("Household food insecurity (%, 3-year avg)") + xlab("")
```



We'll use this information to create subsets of the US, with Mississippi, Arkansas, Texas, and Alabama comprising the "high" food insecurity states, and North Dakota, Virginia, New Hampshire, and Minnesota making up the "low" food insecurity states.
```{r}
high_insecurity_states <- c('MS', 'AR', 'TX', 'AL')
low_insecurity_states <- c('ND', 'VA', 'NH', 'MN')
fea_high <- filter(fea, State %in% high_insecurity_states)
fea_high$State <- paste('high', sep = '_', fea_high$State)
fea_low <- filter(fea, State %in% low_insecurity_states)
fea_low$State <- paste('low', sep = '_', fea_low$State)
```

## Let's explore variables that may be associated with food insecurity

### Median household income

We expect median household incomes to be low in areas of high food insecurity and high in areas of low food insecurity. The below graphs look at county median household income across the US, and focuses in on states with the highest and lowest food insecurity rates.
```{r}
county_choropleth(mutate(fea, value = MEDHHINC10), title = 'Median Household Income by County (2010)')
# + scale_fill_brewer(palette = "Greens") # Alaska and Hawaii are still blue
```

```{r}
ggplot() + 
  geom_density(data = fea_high, aes(MEDHHINC10, color = State, fill = State), alpha = 0.1) + 
  geom_density(data = fea, aes(MEDHHINC10, color = 'US', fill = 'US'), alpha = 0.1) + 
  xlab('Median Household Income (County)') +
  ggtitle('Median Household Income (County): \n Highest Food Insecurity States & US (2010)') + 
  scale_x_continuous(labels = scales::dollar)
```

```{r}
ggplot() + 
  geom_density(data = fea_low, aes(MEDHHINC10, color = State, fill = State), alpha = 0.1) + 
  geom_density(data = fea, aes(MEDHHINC10, color = 'US', fill = 'US'), alpha = 0.1) + 
  xlab('Median Household Income (County)') +
  ggtitle('Median Household Income (County): \n Lowest Food Insecurity States & US (2010)') + 
  scale_x_continuous(labels = scales::dollar)
```

As expected, county median household incomes for highly food insecure states are lower than for the US as a whole, while low food insecurity states have incomes distributed higher than for the US in general.

### Poverty

Similarly, we can examine the relationship between the county-level poverty rate and state-level food insecurity rate.  The poverty rate is defined as the percentage of county residents with household income below the poverty threshold, and the child poverty rate is defined as the percentage of county residents under age 18 living in households with income below the poverty threshold.

```{r}
ggplot(fea, aes(x = POVRATE10, FOODINSEC_10_12)) + geom_point(alpha = 0.5) + 
  xlab('Poverty Rate (%)') + 
  ylab('Food Insecurity (%)') + 
  ggtitle("State Food Insecurity % (2010-2012 Avg) vs County Poverty Rate (2010), \n with Median") + 
  geom_vline(xintercept = median(fea$POVRATE10, na.rm = TRUE), linetype = 'longdash')
```

```{r}
ggplot(fea, aes(x = CHILDPOVRATE10, FOODINSEC_10_12)) + geom_point(alpha = 0.5) + 
  xlab('Child Poverty Rate (%)') + 
  ylab('Food Insecurity (%)') + 
  ggtitle("State Food Insecurity % (2010-2012 Avg) vs County Child Poverty Rate (2010), \n with Median") + 
  geom_vline(xintercept = median(fea$CHILDPOVRATE10, na.rm = TRUE), linetype = 'longdash')
```

Plotting state-level against county-level data makes understanding the true relationship between food insecurity and poverty difficult, especially because variance of poverty rates can be high within a state. Nevertheless, we can see that there is somewhat of a positive association between food insecurity with poverty and child poverty rates.  Also, the states with highest food insecurity tend to have the majority of county poverty rates above the US county median.

### Access to food

Part of our initial hypothesis was that food insecurity is related to low access to food. The dataset defines low access to store (%) as the “percentage of people in a county living more than 1 mile from a supermarket, supercenter or large grocery store if in an urban area, or more than 10 miles from a supermarket or large grocery store if in a rural area.” Is low store access more of an issue in counties with high food insecurity?

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = PCT_LACCESS_POP10)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = PCT_LACCESS_POP10)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = PCT_LACCESS_POP10)) + 
  ylab('% Low Access to Store (County)') + 
  ggtitle('Low Access to Store (%) (County), with US Median (2010)') + 
  geom_hline(yintercept = median(fea$PCT_LACCESS_POP10, na.rm = TRUE), linetype = 'longdash')
```

From the above graph with multiple box plots, low access to store does not appear to be associated with food insecurity. In fact, at least half of the counties in AL, AR, and MS have low store access numbers lower than the US county median, while a higher proportion of people in MN and ND, where food insecurity is low, live far from stores. This suggests that physical access to stores is not a main factor related to food insecurity.

### Other

```{r}
state_choropleth(mutate(state_data, value = FOOD_TAX11), title = "General Food Sales Tax (2011)")
```

It's ironic that 3 of the 4 states (AL, AR, MS) with the highest food insecurity rates levy a general food sales tax, while most states in the US do not have a general food sales tax.  Is this tax related to food insecurity, and if so, is this a chicken-and-egg problem?

```{r}
# Can use diverging color scheme / stacked bar chart for above/below - can't figure out
ggplot() + 
  geom_point(data = fea_high, aes(x = State, y = MILK_PRICE10)) + 
  geom_point(data = fea_low, aes(x = State, y = MILK_PRICE10)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = MILK_PRICE10)) + 
  ggtitle('Price of low-fat milk / national average (Region)') + 
  coord_flip()
# scale_color_manual(name = "ratio", values = c("[0, 1]" = "yellow", "(1,2]" = "red"), labels = c("< 1", "> 1"))
```

## Diving into states







```{r}
# Isolate the extremes/outliers
county_choropleth(mutate(fea, value = POVRATE10), state_zoom = c('north dakota', 'virginia', 'new hampshire', 'minnesota', 'mississippi', 'arkansas', 'texas', 'alabama'), title = 'Poverty Rate (2010), Highest and Lowest Food Insecurity States')
```

```{r}
# Isolate the extremes/outliers
county_choropleth(mutate(fea, value = PC_SNAPBEN10), state_zoom = c('north dakota', 'virginia', 'new hampshire', 'minnesota', 'mississippi', 'arkansas', 'texas', 'alabama'), title = 'SNAP benefits per capita (2010), Highest and Lowest Food Insecurity States')
##### Make NA's gray
```

```{r}
county_choropleth(mutate(fea, value = POVRATE10), state_zoom = c('mississippi', 'arkansas', 'texas', 'alabama'), title = 'Poverty Rate (2010), High Food Insecurity States')
```

```{r}
county_choropleth(mutate(fea, value = PC_SNAPBEN10), state_zoom = c('mississippi', 'arkansas', 'texas', 'alabama'), title = 'SNAP benefits per capita (2010), High Food Insecurity States')
##### Make NA a different color
```

```{r}
### Can I change color?
county_choropleth(mutate(fea, value = POVRATE10), state_zoom = "mississippi", title = 'Poverty Rate (2010) by County for Mississippi')
```

```{r}
county_choropleth(mutate(fea, value = PC_SNAPBEN10), state_zoom = "mississippi", title = 'SNAP benefits per capita (2010) for Mississippi')
```

It looks like SNAP benefits are used in high poverty counties, which means that food assistance money is going to areas that need it.


## Old stuff below

Using FOODINSEC_10_12:
* The 4 states with the highest food insecurity are: MS, AR, TX, AL
* The 4 states with the lowest food insecurity are: ND, VA, NH, MN

Look at the highest insecurity states and examine:
* Comparisons against:
  * lowest insecurity states
  * rest of US
  * all of US
* Note: insecurity values are at the state level
* Which features correlate most with insecurity
* How insecurity and other variables vary at the county level

```{r}
# Subset the data to highest insecurity states, rest of US, and lowest insecurity states
high_insecurity_states <- c('MS', 'AR', 'TX', 'AL')
low_insecurity_states <- c('ND', 'VA', 'NH', 'MN')
fea_high <- filter(fea, State %in% high_insecurity_states)
fea_high$State <- paste('high', sep = '_', fea_high$State)
fea_not_high <- filter(fea, !State %in% high_insecurity_states)  # Not low either?
fea_low <- filter(fea, State %in% low_insecurity_states)
fea_low$State <- paste('low', sep = '_', fea_low$State)
```

Look at food insecurity across time.  Remember, the recession put more households into food insecurity.  Also, the time gap is bigger between 00-02 and 07-09 than 07-09 and 10-12.

```{r}
# Could tidy up the data to make this plot better
ggplot() + 
  geom_point(data = fea_high, aes(x = State, y = FOODINSEC_00_02), color = 'red') + 
  geom_boxplot(data = fea, aes(x = 'US 00-02', y = FOODINSEC_00_02), color = 'red') + 
  geom_point(data = fea_high, aes(x = State, y = FOODINSEC_07_09), color = 'green') + 
  geom_boxplot(data = fea, aes(x = 'US 07-09', y = FOODINSEC_07_09), color = 'green') + 
  geom_point(data = fea_high, aes(x = State, y = FOODINSEC_10_12), color = 'blue') + 
  geom_boxplot(data = fea, aes(x = 'US 10-12', y = FOODINSEC_10_12), color = 'blue') + 
  ggtitle('Food Insecurity Rates (State)')
```

### Other variables tried out:
* Some association: MEDHHINC10, POVRATE10, CHILDPOVRATE10, MILK_PRICE10 (sample size too small), FOOD_TAX11, PC_FFRSALES07, PC_FSRSALES07
* Not associated: PCT_LACCESS_POP10, PCT_LACCESS_LOWI10, REDEMP_SNAPS12, SNAPSPTH12, FFRPTH12, FSRPTH12, GROCPTH12, SUPERCPTH12, CONVSPTH12, PCT_65OLDER10, PCT_18YOUNGER10

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = MEDHHINC10)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = MEDHHINC10)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = MEDHHINC10)) +
  geom_boxplot(data = fea, aes(x = 'US', y = MEDHHINC10)) + 
  ggtitle('Median HH Income (County)')
```

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = POVRATE10)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = POVRATE10)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = POVRATE10)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = POVRATE10)) + 
  ggtitle('Poverty Rate (County)')
```

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = CHILDPOVRATE10)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = CHILDPOVRATE10)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = CHILDPOVRATE10)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = CHILDPOVRATE10)) + 
  ggtitle('Child Poverty Rate (County)')
```





```{r}
ggplot() + 
  geom_point(data = fea_high, aes(x = State, y = PC_FFRSALES07)) + 
  geom_point(data = fea_low, aes(x = State, y = PC_FFRSALES07)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = PC_FFRSALES07)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = PC_FFRSALES07)) + 
  ggtitle('Per Capita Fast Food Restaurant Expenditures (State)')
```

```{r}
ggplot() + 
  geom_point(data = fea_high, aes(x = State, y = PC_FSRSALES07)) + 
  geom_point(data = fea_low, aes(x = State, y = PC_FSRSALES07)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = PC_FSRSALES07)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = PC_FSRSALES07)) + 
  ggtitle('Per Capita Full Service Restaurant Expenditures (State)')
```

The following do not seem to be associated with food insecurity.

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = PCT_LACCESS_LOWI10)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = PCT_LACCESS_LOWI10)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = PCT_LACCESS_LOWI10)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = PCT_LACCESS_LOWI10)) + 
  ggtitle('Low Income & Low Access to Store (%) (County)')
```

```{r}
ggplot() + 
  geom_boxplot(data = fea_high, aes(x = State, y = REDEMP_SNAPS12)) + 
  geom_boxplot(data = fea_low, aes(x = State, y = REDEMP_SNAPS12)) + 
  geom_boxplot(data = fea_not_high, aes(x = 'rest of US', y = REDEMP_SNAPS12)) + 
  geom_boxplot(data = fea, aes(x = 'US', y = REDEMP_SNAPS12)) + 
  ggtitle('SNAP redemptions / SNAP-authorized stores (County)')
```

### Older stuff

```{r}
file <- '/Users/rachelhz/projects/food_environ_atlas_analysis/food_environment_atlas_2015.xls'
insecurity <- read_excel(file, sheet = 'INSECURITY')
```

```{r}
str(insecurity)
# Plot food insecurity rates (children) by years
ggplot(insecurity) + 
  geom_boxplot(aes(x = 1, y = FOODINSEC_CHILD_01_07)) +
  geom_boxplot(aes(x = 2, y = FOODINSEC_CHILD_03_11))
# Plot food insecurity rates (children) by years against each other
ggplot(insecurity, aes(x = FOODINSEC_CHILD_01_07, y = FOODINSEC_CHILD_03_11)) + geom_point(alpha = 0.3)
```
```{r}
assistance <- read_excel(file, sheet = 'ASSISTANCE')
```

```{r}
head(assistance)
```

### Function for plotting state-level data on maps

For Molly:
* Have ggmap installed and loaded (see top of notebook)
* Use load_state_geo() to bring in state geo data
* Join the state geo data with your data
* Plot the data

```{r}
# Function that loads in state lon/lat data
load_state_geo <- function() {
  # Bring in lat/long data by state name
  state_geo <- map_data("state")
  head(state_geo)
  # Bring in state names and abbreviations
  data(state)
  state_abbrevs <- tibble(abb = state.abb, region = tolower(state.name))
  # Merge to match state abbreviations with lat/long
  state_df <- full_join(state_geo, state_abbrevs, by = "region")
  return(state_df)
}

state_df <- load_state_geo()
head(state_df)
```

```{r}
# DOES NOT WORK, IGNORE!

# Join feature_df into geo data, then plot 'feature_to_plot'
# If you want the joined df, set return_df = TRUE
join_plot_state <- function(state_df, feature_df, feature_to_plot, return_df = FALSE) {
  state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))
  
  ggplot(state_feature, aes(x = long, y = lat, fill = feature_to_plot, group = group)) + 
    geom_polygon(color = "white") +
    scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
    coord_fixed(1.3)
  
  #if(return_df == TRUE) {
   # return(state_feature)
  #}
}

join_plot_state(state_df, feature_df, PCT_SNAP14)
```


```{r}
### Here is how to plot by state ###

# Bring in state geo data
state_df <- load_state_geo()

# Summarize 'df' by State using 'group_by_function' on 'feature', then plot by state
# Note: 'df' must have a column of state abbrevs called 'State'

assistance %>% 
  group_by(State) %>% 
  summarise(summ_feature = mean(PCT_SNAP14)) ->
  feature_df

state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))

ggplot(state_feature, aes(x = long, y = lat, fill = summ_feature, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3)
```


Use the package 'noncensus' has population and other relevant data for counties and zip codes!!! https://cran.r-project.org/web/packages/noncensus/noncensus.pdf

```{r}
### This didn't work and takes forever! ###
# Try bringing in FIPS (county) level geo data
library(noncensus)

data("zip_codes")
#zip_codes$fips <- as.character(zip_codes$fips)
assistance$FIPS <- as.numeric(assistance$FIPS)
assistance_zip <- full_join(zip_codes, select(assistance, FIPS, State, County, REDEMP_SNAPS12), by = c('fips' = 'FIPS'))

# See if we can plot something by county
# Clearly, we're missing a lot of data
ggplot(assistance_zip, aes(x = longitude, y = latitude, fill = REDEMP_SNAPS12)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3)

# Things to do to get per capita data by county, and plot by county
data("counties") # Can use this to get county population!
# 1. Make a FIPS column
counties <- mutate(counties, fips = paste(state_fips, county_fips, sep = ''))
# 2. Create a 'group' column in counties so that plotting happens by county
counties <- mutate(counties, group = 1:nrow(counties))
# 3. Merge counties and assistance data by FIPS
assistance_county <- full_join(assistance, counties, by = c('FIPS' = 'fips'))
# 4. Create new column if need be
assistance_county <- mutate(assistance_county, PCREDEMP_SNAPS12 = REDEMP_SNAPS12 / population)
# (Or plot PC_SNAPBEN08, which has per capita data already and little missing data)
# 5. Merge with zip code lat/lon data
assistance_county_geo <- full_join(assistance_county, zip_codes, by = c('FIPS' = 'fips'))
# 6. Plot!
ggplot(assistance_county_geo, aes(x = longitude, y = latitude, fill = PC_SNAPBEN08, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3)
```

### Compare per capita expenditures on: farm, fast food, restaurants, hh income

```{r}
file <- '/Users/rachelhz/projects/food_environ_atlas_analysis/fea_02182017.csv'
fea <- read_csv(file)
```

Variables of interest:
* PC_DIRSALES07: Direct farm sales per capita, 2007
* PC_FFRSALES07: Expenditures per capita, fast food, 2007 (state level)
* PC_FSRSALES07: Expenditures per capita, restaurants, 2007 (state level)
* MEDHHINC10: Median household income, 2010

```{r}
fea_expend <- select(fea, FIPS, State, PC_DIRSALES07, PC_FFRSALES07, PC_FSRSALES07, MEDHHINC10)
head(fea_expend)
```

```{r}
library(GGally)
# Note: this plot can be misleading because the fast food and restaurant sale data is by state
ggpairs(select(fea_expend, PC_DIRSALES07, PC_FFRSALES07, PC_FSRSALES07, MEDHHINC10), mapping = aes(alpha = 0.5))
```

```{r}
# There are only 50 states
ggplot(fea_expend, aes(PC_FFRSALES07, PC_FSRSALES07)) + geom_point()
```
Overall, full-service restaurant expenditures seem to grow with fast food restaurant expenditures.

```{r}
library(gridExtra)
grid.arrange(
# Fast food expenditures by median hh income
ggplot(fea_expend, aes(MEDHHINC10, PC_FFRSALES07)) + geom_point(size = 0.2, alpha = 0.5), 
# Restaurant expenditures by median hh income
ggplot(fea_expend, aes(MEDHHINC10, PC_FSRSALES07)) + geom_point(size = 0.2, alpha = 0.5), 
nrow = 2)
```
Observations:
* There seems to be a general range ($500-800) of per capita fast food expenditures that applies across the bulk of incomes.
* There seems to be a general range ($400-900) of per capita restaurant expenditures that applies across most incomes.
* Interesting that expenditures for eating out are pretty consistent across rich and poor counties/states.

```{r}
# Plot fast food expenditures on a map

# Bring in state geo data
state_df <- load_state_geo()

# Summarize 'df' by State using 'group_by_function' on 'feature', then plot by state
# Note: 'df' must have a column of state abbrevs called 'State'

fea_expend %>% 
  group_by(State) %>% 
  summarise(PC_FFRSALES07 = mean(PC_FFRSALES07)) ->
  feature_df

state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))

ggplot(state_feature, aes(x = long, y = lat, fill = PC_FFRSALES07, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3) + 
  ggtitle('PC_FFRSALES07 by State')
```

```{r}
# Plot restaurant expenditures on a map

# Bring in state geo data
state_df <- load_state_geo()

# Summarize 'df' by State using 'group_by_function' on 'feature', then plot by state
# Note: 'df' must have a column of state abbrevs called 'State'

fea_expend %>% 
  group_by(State) %>% 
  summarise(PC_FSRSALES07 = mean(PC_FSRSALES07)) ->
  feature_df

state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))

ggplot(state_feature, aes(x = long, y = lat, fill = PC_FSRSALES07, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3) + 
  ggtitle('PC_FSRSALES07 by State')
```

```{r}
# Plot hh median income on a map

# Bring in state geo data
state_df <- load_state_geo()

# Summarize 'df' by State using 'group_by_function' on 'feature', then plot by state
# Note: 'df' must have a column of state abbrevs called 'State'

fea_expend %>% 
  group_by(State) %>% 
  summarise(MEDHHINC10_mean = mean(MEDHHINC10)) ->
  feature_df

state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))

ggplot(state_feature, aes(x = long, y = lat, fill = MEDHHINC10_mean, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3) + 
  ggtitle('MEDHHINC10_mean by State')
```

```{r}
# Plot median hh income by county
data("zip_codes")
zip_codes$fips <- as.character(zip_codes$fips)
joined_zip <- full_join(zip_codes, select(fea_expend, FIPS, MEDHHINC10), by = c('fips' = 'FIPS'))

# See if we can plot something by county
# Clearly, we're missing a lot of data
ggplot(joined_zip, aes(x = longitude, y = latitude, fill = MEDHHINC10, group = fips)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar")+
  coord_fixed(1.3) + 
  ggtitle('MEDHHINC10 by County')
```

```{r}
# Bring in state geo data
state_df <- load_state_geo()

# Summarize 'df' by State using 'group_by_function' on 'feature', then plot by state
# Note: 'df' must have a column of state abbrevs called 'State'

fea_expend %>% 
  group_by(State) %>% 
  summarise(PC_DIRSALES07_mean = mean(PC_DIRSALES07)) ->
  feature_df

state_feature <- full_join(state_df, feature_df, by = c('abb' = 'State'))

ggplot(state_feature, aes(x = long, y = lat, fill = PC_DIRSALES07_mean, group = group)) + 
  geom_polygon(color = "white") +
  scale_fill_continuous(low = "#fee5d9", high = "#a50f15", guide="colorbar") +
  coord_fixed(1.3) + 
  ggtitle('PC_DIRSALES07_mean by State')
```

Observations:
* We have very little farm sales data, so we probably shouldn't use this information.

### Correlation among socioeconomic variables, eg. race against poverty/income/metro, so that we can use a single factor in later analyses

Socioeconomic variables:

```{r, warning=FALSE}
fea_socioecon <- select(fea, FIPS, State, PCT_NHWHITE10, PCT_NHBLACK10, PCT_HISP10, PCT_NHASIAN10, PCT_NHNA10, PCT_NHPI10, PCT_65OLDER10, PCT_18YOUNGER10, MEDHHINC10, POVRATE10, PERPOV10, CHILDPOVRATE10, PERCHLDPOV10, METRO13, POPLOSS00)

# Plot race against income against metro area
ggplot(fea_socioecon, aes(MEDHHINC10, POPLOSS00)) + geom_point(alpha = 0.5) + facet_wrap(~METRO13)
```

Observations (looking at % of category compared to median hh income):
* Out of most races, only Asians seem to appear more in counties with higher median income
* PCT_NHPI10: can remove, make up a low percentage of populations
* PCT_18YOUNGER10: pretty uninformative
* PCT_65OLDER10: not so informative either
* POVRATE10, CHILDPOVRATE10: Poverty rate and child poverty rate are highly linearly related!; as expected, is nearly inversely related to MEDHHINC10
  * most households under the poverty line have children
* PERPOV10: exists for some counties on very low end of MEDHHINC10
* PERCHLDPOV10: exists for a wider range of incomes, compared to PERPOV10, at the low end of the spectrum
 * POPLOSS00: happens more for lower half end of MEDHHINC10

```{r}
ggplot(fea_socioecon, aes(POVRATE10, CHILDPOVRATE10)) + geom_point(alpha = 0.5)
```

